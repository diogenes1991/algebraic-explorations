<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
  
    <head>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>MadScientist Dio</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,600,700,800,900" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css">
        <link rel="stylesheet" href="madisqe-global.css">
        <link rel="stylesheet" href="madisqe-landing.css">
        <link rel="author" href="humans.txt">
        <link rel = "icon" href = "Assets/Logo.png" type = "image/x-icon">
        <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
        <script type="text/javascript"src="http://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>

    <body>
        <nav class="header">
            <div class="logo"></div>
            <ul class="menu">
                <div class="menu__item toggle"><span></span></div>
                <li class="menu__item"><a href="https://github.com/diogenes1991/Madisqe" class="link link--dark"><i class="fa fa-github"></i> Github</a></li>
            </ul>
        </nav>

        <div class="wrapper">  <!-- Main wrapper -->
          
            <div id="CanvasWrapper">
                <h1 class="hero__title">Physics Simulation</h1>
                <fieldset>
                    <button id="Begin" class="dropbtn" onclick="ResumePause()">Resume</button>
                    <button id="Begin" class="dropbtn" onclick="RevertTime()">Invert Time</button>
                    <button id="Clear" class="dropbtn" onclick="DeleteParticles()">Clear</button>
                    <button class="dropbtn" onclick="EngineDropdown()">Engine</button>
                    <div id="EngineContent" class="dropdown-content">
                        <button onclick="SetEngine(0)" class="dropbtn">Relativistic</button>
                        <button onclick="SetEngine(1)" class="dropbtn">Classical</button>
                    </div>
                    <button class="dropbtn" onclick="TopologyDropdown()">Topology</button>
                    <div id="TopologyContent" class="dropdown-content">
                        <button onclick="SetTopology(0)" class="dropbtn">Square</button>
                        <button onclick="SetTopology(1)" class="dropbtn">Torus</button>
                    </div>
                </fieldset>
                <canvas id="theCanvas" width="750" height="750" oncontextmenu="return false">
                    Canvas not supported; please update your browser.
                </canvas>
            </div>

            <table class="fixed">
                <tr><td>Cycles</td><td><div id="Cycles"></div></td></tr>
                <tr><td>Kinetic Energy (GeV)</td><td><div id="KineticEnergy"></div></td></tr>
                <tr><td>Potential Total Energy (GeV)</td><td><div id="PotentialEnergy"></div></td></tr>
                <tr><td>Total Energy (GeV)</td><td><div id="TotalEnergy"></div></td></tr>
                <tr><td>Pressure </td><td><div id="Pressure"></div></td></tr>
            </table>

            <fieldset>
                <legend>New Particle Parameters</legend>
                <p> 
                    <div>Selected Type: </div><div id="SelectedType"></div>
                    <br>
                    <label>$p_x = $ </label>
                    <input type = "text" id = "inputPx" value="0" /> GeV
                    <br>
                    <label>$p_y = $ </label>
                    <input type = "text" id = "inputPy" value="0" /> GeV
                    <br>
                    <br>
                    <button class="dropbtn" onclick="TypeDropdown()">Type</button>
                        <div id="TypeContent" class="dropdown-content">
                              <button onclick="SetType(0)" class="dropbtn">Hydrogen</button>
                              <button onclick="SetType(1)" class="dropbtn">Proton</button>
                              <button onclick="SetType(2)" class="dropbtn">Electron</button>
                              <button onclick="SetType(3)" class="dropbtn">Photon</button>
                        </div>
                </p>
            </fieldset>
            
            <fieldset>
                <legend>Electrodynamic Parameters</legend>
                <table class="fixed">
                    <tr><td>$\alpha_0$ = </td><td><input type = "text" id = "Alpha0" value="0.0" /></td></tr>
                </table>
                <br>
                <button onclick="UpdateParameters()" class="dropbtn"> Update </button>
                </p>
            </fieldset>
        </div>

    <footer class="footer">madisqe 1.0.0</footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="madisqe.js"></script>
    
    <style type="text/css">
        
        canvas {
            border: 2px solid black;
        }  

        input {
            border: 1px solid black;
            width: 100px;
            height: 20px;
            text-align: center;
        }

        .fixed{
            table-layout:fixed;
            /*table.fixed td { overflow: hidden;*/
        }
        /* Dropdown Button */
        .dropbtn {
          background-color: #3498DB;
          color: white;
          padding: 16px;
          font-size: 16px;
          border: none;
          cursor: pointer;
        }
      
        /* Dropdown button on hover & focus */
        .dropbtn:hover, .dropbtn:focus {
          background-color: #2980B9;
        }
      
        /* The container <div> - needed to position the dropdown content */
        .dropdown {
          position: relative;
          display: inline-block;
        }
      
        /* Dropdown Content (Hidden by Default) */
        .dropdown-content {
          display: none;
          position: absolute;
          background-color: #f1f1f1;
          min-width: 160px;
          box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
          z-index: 1;
        }
      
        /* Links inside the dropdown */
        .dropdown-content a {
          color: black;
          padding: 12px 16px;
          text-decoration: none;
          display: block;
        }
      
        /* Change color of dropdown links on hover */
        .dropdown-content a:hover {background-color: #ddd}
      
        /* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
        .show {display:block;}
    </style>

    <script>

        // This script attempts to create a fully covariant 
        // simulation environment, of course the Canvas exists
        // on the limited scope of a frame, but one should not 
        // identify Camvas=Frame it is rather Canvas=Scope
        // what this means is that the canvas can be shifted 
        // to represent another frame and back without much effort
        // The displays are attached to frame dependant quantities 
        // merely because they are useful constructs within the scope 
        // of a fixed frame.

        // Dimensionful quantities 
        // The simulation uses c = 1 = 1px/Cycle
        // the cycles take time to fully render 
        // and the next cycle is set to be computed 
        // 3ms into the future, if the computations 
        // are fast then this is the leading driver 
        // for the speed of the partiles on the canvas

        // The scope quantity is the overhead class that will handle
        // all the fields present in the canvas

        class Scope{

            constructor(Canvas){
                this.Canvas     = Canvas
                this.Context    = Canvas.getContext("2d")
                this.IsRunning  = false
                this.Topology   = 1
                this.Fields     = []
                this.Potentials = []
            }



            SetTopology(T){this.Topology=T}

            Evolve(){

                // The Scope hadles all the fields 
                // The fields evolve using Wave Equations:
                // dt^2 Phi = Laplacian(Phi)

                for( let i = 0; i < this.Canvas.width; i++ ){
                    for(let j = 0; j < this.Canvas.height; j++){


                    }
                }

            }

        }

        var CycleCount = 0
        var Pressure = 0

        var TotalEnergyDisplay = document.getElementById("TotalEnergy")
        var KineticEnergyDisplay = document.getElementById("KineticEnergy")
        var PotentialEnergyDisplay = document.getElementById("PotentialEnergy")
        var CyclesDisplay = document.getElementById("Cycles")
        var PressureDisplay = document.getElementById("Pressure")

        var theCanvas = document.getElementById("theCanvas");
        var theContext = theCanvas.getContext("2d");
        var isRunning = false

        var Engine = 0
        function SetEngine(T){
            ResumePause()
            Engine=T
            document.getElementById("EngineContent").classList.toggle("show")
            ResumePause()
        }
        function EngineDropdown(){document.getElementById("EngineContent").classList.toggle("show")}


        // Topology 0 : Square
        // Topology 1 : Torus 

        var Topology = 0
        function SetTopology(T){
            Topology=T
            document.getElementById("TopologyContent").classList.toggle("show")
        }

        function TopologyDropdown(){document.getElementById("TopologyContent").classList.toggle("show")}

        //
        //   Type particle selector menu code
        //

        var Particles = []
        var NewParticles = []
        var Type = undefined
        var Types = ["Hydrogen","Proton","Electron","Photon"]
        function SetType(T){
            Type=T
            document.getElementById("SelectedType").innerHTML = Types[T]
            document.getElementById("TypeContent").classList.toggle("show")
        }
        function TypeDropdown(){document.getElementById("TypeContent").classList.toggle("show")}

        theCanvas.addEventListener('click', function (event) {
            var Px = parseFloat(document.getElementById("inputPx").value)
            var Py = parseFloat(document.getElementById("inputPy").value)
            var P  = Math.sqrt(Px*Px+Py*Py) 
            var BB = theCanvas.getBoundingClientRect()
            AddParticle(event.x-BB.left,event.y-BB.top,Px,Py)
        });

        theCanvas.addEventListener('contextmenu', function (event) {
            var B = theCanvas.getBoundingClientRect()
            for( const Par of Particles){
                if (Math.abs(Par.x-event.x+B.left)<3 && Math.abs(Par.y-event.y+B.top)<3){
                    console.log("Particle : ",Par.px,Par.py)
                }   
            }
        });

        //
        //  End particle selector menu code
        //
        
        var Alpha0 = 1/137
        var VanDerWaals = 1
        function UpdateParameters(){
            Alpha0 = parseFloat(document.getElementById("Alpha0").value)
            VanDerWaals = parseFloat(document.getElementById("VanDerWaals").value)
            console.log("Setting Alpha0 = ",Alpha0)
            console.log("Setting VanDerWaals = ",VanDerWaals)
        }

        //
        //   Particle Types
        //

        class Particle{

            rad = 3
            col = "black"
            chg = 0
            fx  = 0
            fy  = 0 
            mas = 0

            constructor(X,Y,PX,PY,Canvas) {
                this.x   = X
                this.y   = Y
                this.px  = PX
                this.py  = PY
                this.en = Math.sqrt(this.mas*this.mas+this.px*this.px+this.py*this.py)
                this.vx = 0
                this.vy = 0
                this.Canvas = Canvas
                this.Context = Canvas.getContext("2d")
            }

            SetForce(FX,FY){
                this.fx = FX
                this.fy = FY
            }

            Evolve(){
                // if(this instanceof Photon){
                    // console.log("Energy",this.en)
                // }
                this.px += this.fx
                this.py += this.fy
                this.SetForce(0,0)
                this.en = Math.sqrt(this.mas*this.mas+this.px*this.px+this.py*this.py)

                //this.px *= 0.999
                //this.py *= 0.999

                // let momx = (2.0/3.0)*this.chg*this.chg*(this.vx-this.px/this.en)
                // let momy = (2.0/3.0)*this.chg*this.chg*(this.vy-this.py/this.en)
                // if(Math.sqrt(momx*momx+momy*momy)>1){
                //     console.log("A new Photon will be radiated with momentum",momx,momy)
                //     NewParticles = [...NewParticles,
                //     new Photon(this.x,this.y,momy,-momx,theCanvas)]
                //     this.en += -momy
                //     this. +=  momx
                // }
                this.vx = this.px/this.en
                this.vy = this.py/this.en
                if(Topology==0){
                    if((this.x+this.vx)>this.Canvas.width||(this.x+this.vx)<0){
                        this.px=-this.px;
                        this.vx=-this.vx;
                        Pressure += Math.abs(this.px);
                    }
                    if((this.y+this.vy)>this.Canvas.height||(this.y+this.vy)<0){
                        this.py=-this.py;
                        this.vy=-this.vy;
                        Pressure += Math.abs(this.py);
                    }
                    this.x = (this.x+this.vx)
                    this.y = (this.y+this.vy)
                }
                else if(Topology==1){
                    this.x = (this.x+this.vx+this.Canvas.width)%this.Canvas.width
                    this.y = (this.y+this.vy+this.Canvas.height)%this.Canvas.height
                }
            }
            
            Draw(){
                theContext.beginPath()
                theContext.arc(this.x,this.y,this.rad,0,2*Math.PI)
                theContext.fillStyle = this.col
                theContext.fill()
            }
        }

        class Hydrogen extends Particle{

            rad = 3
            col = "black"
            chg = 0
            mas = 0.99999
        }

        class Proton extends Particle{

            rad = 2
            col = "red"
            chg = 1
            mas = 1
        }

        class Electron extends Particle{

            rad = 2
            col = "blue"
            chg = -1
            mas = 0.000511
        }

        class Photon extends Particle{

            rad = 2
            col = "green"
            chg = 0
            mas = 0

            Draw(){
                theContext.beginPath()
                theContext.arc(this.x,this.y,this.rad,0,2*Math.PI)
                theContext.fillStyle = convert(this.en)
                theContext.fill()
            }
        }

        //
        //       Engines
        //

        //
        //  Relativistic Engine
        //

        function Evolve(){
            ClearCanvas()
            NewParticles = []
            CycleCount += 1
            var K=0,U=0
            for (const Par of Particles) {
                var FX=0,FY=0
                K += Par.en-Par.mas
                for (const Par2 of Particles){
                    if (Par == Par2) continue
                    Factor = Alpha0*Alpha0*Par.chg*Par2.chg
                    if(Factor){
                        var D = Math.sqrt(Math.pow(Par.x-Par2.x,2)+Math.pow(Par.y-Par2.y,2))
                        var Gamma = 1 - Par.vx*Par2.vx - Par.vy*Par2.vy
                        var Dot = Par.vx*(Par.x-Par2.x) + Par.vy*(Par.y-Par2.y)
                        U  += -(Factor*Math.log(D))/2
                        FX += Factor*( Par2.vx * Dot + Gamma * (Par.x-Par2.x) )/Math.pow(D,2)
                        FY += Factor*( Par2.vy * Dot + Gamma * (Par.y-Par2.y) )/Math.pow(D,2)
                        if(FX==NaN||FY==NaN){
                            isRunning = false
                            alert("Warning Unbounded Forces found")
                        }
                    }
                    if (Par instanceof Photon){
                        Factor = Alpha0*Alpha0*Par2.chg*Par2.chg
                        if(Factor){
                            var D = Math.sqrt(Math.pow(Par.x-Par2.x,2)+Math.pow(Par.y-Par2.y,2))
                            FX += Factor * (Par.x-Par2.x)/Math.pow(D,3)
                            FY += Factor * (Par.y-Par2.y)/Math.pow(D,3)
                        }
                    }
                    else if (Par2 instanceof Photon){
                        Factor = Alpha0*Alpha0*Par.chg*Par.chg
                        if(Factor){
                            var D = Math.sqrt(Math.pow(Par.x-Par2.x,2)+Math.pow(Par.y-Par2.y,2))
                            FX += Factor * (Par2.x-Par.x)/Math.pow(D,3)
                            FY += Factor * (Par2.y-Par.y)/Math.pow(D,3)
                        }
                    }
                }
                Par.SetForce(FX,FY)
            }
            for(const Par of Particles){
                Par.Evolve()
                Par.Draw()
            }
            for(Par of NewParticles){
                Particles = [...Particles,Par]
                Par.Draw()
            }
            KineticEnergyDisplay.innerHTML = K
            PotentialEnergyDisplay.innerHTML = U
            TotalEnergyDisplay.innerHTML = K + U
            CyclesDisplay.innerHTML = CycleCount
            if(CycleCount%500==0){
                PressureDisplay.innerHTML = Pressure/CycleCount;
                Pressure = 0
            }
            if(isRunning) window.setTimeout(Evolve,3)
        }

        //
        //  Classical Engine
        //

        function Evolve2(){
            ClearCanvas()
            CycleCount += 1
            var K=0,U=0
            for (const Par of Particles) {
                var FX=0,FY=0
                K += Par.en-Par.mas
                for (const Par2 of Particles){
                    if (Par == Par2) continue
                    var D = Math.sqrt(Math.pow(Par.x-Par2.x,2)+Math.pow(Par.y-Par2.y,2))
                    U  += (VanDerWaals*Math.pow(D,3))/6
                    FX += VanDerWaals*(Par.x-Par2.x)/Math.pow(D,5)
                    FY += VanDerWaals*(Par.y-Par2.y)/Math.pow(D,5)
                }
                Par.SetForce(FX,FY)
            }
            for(const Par of Particles){
                Par.Evolve()
                Par.Draw()
            }
            KineticEnergyDisplay.innerHTML = K
            PotentialEnergyDisplay.innerHTML = U
            TotalEnergyDisplay.innerHTML = K + U
            CyclesDisplay.innerHTML = CycleCount
            if(CycleCount%500==0){
                PressureDisplay.innerHTML = Pressure/CycleCount;
                Pressure = 0
            }
            if(isRunning) window.setTimeout(Evolve2,3)
        }

        //
        // Chemical Engine : Using Effective Hamiltonians, currently broken
        //  

        function React(){
            var Repeat = false
            for(var i = 0; i<Particles.length; i++){
                var Break = false
                for(var j = i+1; j<Particles.length; j++){
                    var Par = Particles[i]
                    var Par2 = Particles[j]
                    var D = Math.sqrt(Math.pow(Par.x-Par2.x,2)+Math.pow(Par.y-Par2.y,2))
                    if(D<1 && ( (Par instanceof Electron && Par2 instanceof Proton) || (Par2 instanceof Electron && Par instanceof Proton) ) ){
                        var v = Alpha0*Math.sqrt(1/(2*1837-Alpha0*Alpha0))
                        var vx = v*Math.cos(Math.PI/3)
                        var vy = v*Math.sin(Math.PI/3) 
                        H = new Hydrogen((Par.x+Par2.x)/2-2,(Par.y+Par2.y)/2-2,-vx,-vy,theCanvas)
                        A = new Photon((Par.x+Par2.x)/2+2,(Par.y+Par2.y)/2+2,1,1,theCanvas)
                        Particles.splice(j,1)
                        Particles.splice(i,1)
                        Particles = [...Particles,H,A]
                        Break = true
                        break
                    }
                    // if(D<1 && ( (Par instanceof Hydrogen && Par2 instanceof Photon) || (Par2 instanceof Hydrogen && Par instanceof Photon) ) ){
                    //     E = new Electron((Par.x+Par2.x)/2+5,(Par.y+Par2.y)/2+5,0,0,theCanvas)
                    //     P = new Proton((Par.x+Par2.x)/2-5,(Par.y+Par2.y)/2-5,0,0,theCanvas)
                    //     Particles.splice(j,1)
                    //     Particles.splice(i,1)
                    //     Particles = [...Particles,E,P]
                    //     Break = true
                    //     break
                    // }
                }
                if(Break){
                    Repeat = true
                    break
                }
            }
            if(Repeat) React()
        }

        //
        //   Engine handlers
        //

        function ClearCanvas(){
          theContext.clearRect(0,0,theCanvas.width,theCanvas.height)
        }

        function ResumePause(){
            isRunning = !isRunning
            var Name = document.getElementById("Begin").innerHTML
            document.getElementById("Begin").innerHTML = (Name=="Resume"?"Pause":"Resume")
            if(Engine == 0) Evolve()
            else if (Engine ==1 ) Evolve2()
        }

        function RevertTime(){
            for(Par of Particles){
                Par.px = -Par.px
                Par.py = -Par.py
            }
        }

        function AddParticle(x,y,px,py){
            if (Type == 0) P = new Hydrogen(x,y,px,py,theCanvas)
            else if (Type == 1) P = new Proton(x,y,px,py,theCanvas)
            else if (Type == 2) P = new Electron(x,y,px,py,theCanvas)
            else if (Type == 3){
                if(Math.sqrt(px*px+py*py)<0.001){
                    alert("Photon too soft, the minimum energy is 1MeV")
                    return
                }
                else{
                    P = new Photon(x,y,px,py,theCanvas)
                }
            }
            else {
                alert("Particle Type not set")
                return
            }
            P.Draw()
            Particles = [...Particles,P]
        }

        function DeleteParticles(){
            do{
                Particles.pop()
            }while (Particles.length);
            CycleCount = -1
            Evolve()
        }

        //
        //   Color code for Photons
        //

        function trim1 (str){
            return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
        }

        function decimalToHex(d) {
            d = Math.round(d);
            var hex = d.toString(16);
            while (hex.length < 2) {
                hex = "0" + hex;
            }
        
            return hex;
        }

        function convert(momentum){

            //  We will map an effective range from 1GeV to 1TeV
            //  that is 1GeV -> 780nm
            //          1TeV -> 380nm

            let w = 780 - 400*(momentum-1)/999
        
            if (w >= 380 && w < 440){
                red   = -(w - 440) / (440 - 380);
                green = 0.0;
                blue  = 1.0;
            }
            else if (w >= 440 && w < 490){
                red   = 0.0;
                green = (w - 440) / (490 - 440);
                blue  = 1.0;
            }
            else if (w >= 490 && w < 510){
                red   = 0.0;
                green = 1.0;
                blue  = -(w - 510) / (510 - 490);
            }
            else if (w >= 510 && w < 580){
                red   = (w - 510) / (580 - 510);
                green = 1.0;
                blue  = 0.0;
            }
            else if (w >= 580 && w < 645){
                red   = 1.0;
                green = -(w - 645) / (645 - 580);
                blue  = 0.0;
            }
            else if (w >= 645 && w < 781){
                red   = 1.0;
                green = 0.0;
                blue  = 0.0;
            }
            else{
                red   = 0.0;
                green = 0.0;
                blue  = 0.0;
            }
            
            var factor = 1.0
            var gamma = 0.80;
            var R = (red   > 0 ? 255*Math.pow(red   * factor, gamma) : 0);
            var G = (green > 0 ? 255*Math.pow(green * factor, gamma) : 0);
            var B = (blue  > 0 ? 255*Math.pow(blue  * factor, gamma) : 0); 
        
            var hex = "#" + decimalToHex(R) + decimalToHex(G) + decimalToHex(B);
            return hex
        }

    </script>
    </body>
</html>